<!DOCTYPE html>
<html>
  <!-- the data.csv is got from
    https://data.europa.eu/euodp/en/data/dataset/covid-19-coronavirus-data

    where I assume I can pull by pointing to:
        https://opendata.ecdc.europa.eu/covid19/casedistribution/csv
  
    TODO
      - add bar chart showing daily cases+deaths (stacked) along bottom
        of right chart (only there on hover)
      - add dashed line with max value
   -->
  <meta charset="utf-8">
  <head>
    <style>

      #info {
        font-size: 0.8em;
      }
      
      .datapoint {
        stroke: darkgray;
        stroke-width: 1px;
        opacity: 0.45;
      }

      .label {
        font-size: 10px;
        color: darkgray;
        font-family: 'Open Sans Condensed', sans-serif;
      }

      .legend-entry {
        padding: 2px;
        font-size: 14px;
        font-family: 'Open Sans Condensed', sans-serif;    
      }
      
      #date {
        font-family: 'Open Sans Condensed', sans-serif;
        color: lightgray;
        font-weight: 300;
        font-size: 48px;
      }

      .line {
        fill: none;
        stroke-width: 3;
      }

      .track-inset {
        stroke: #fff;
      }

      #myContainer {
        margin: 0;
        padding: 0;
      }

      .axislabel {
        font-family: 'Open Sans Condensed', serif, sans-serif; 
        font-size: 32px;
      }

      svg {
        overflow: visible;
      }

      #menu1 {
        background-color: indianred !important;
        border-color: indianred !important;
      }

      #clearButton {
        background-color: firebrick !important;
        border-color: firebrick !important;
      }

      #country-drop-down {
        height: auto;
        max-height: 200px;
        overflow-x: hidden;
      }


    </style>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider@0.1.2/build/d3-simple-slider.js"></script>  
    <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div id="date"></div>
    <div class="container" id="myContainer">
      <div class="row">
        <div class="col-sm-6" id="slider"></div>
        <div class="col-sm-6" id="controls">
          <button id="clearButton"
                  type="button"
                  class="btn btn-primary"
                  onClick="clearFn()">Clear</button>
          <button class="btn btn-primary dropdown-toggle"
                  id="menu1"
                  type="button"
                  data-toggle="dropdown">Add Country
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu" aria-labelledby="menu1" id="country-drop-down">
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6" id="info">On the left see the number of deaths versus number of cases over time by dragging the scrollbar. Click a country to see their death toll over time on the right (hover over this to see daily case break down.</div></div>
      <div class="row">
        <div class="col-sm-6" id="graph"></div>
        <div class="col-sm-6" id="linegraph"></div>
      </div>
      <div>data source: <a href="https://opendata.ecdc.europa.eu/">https://opendata.ecdc.europa.eu/</a></div>
    </div>
  </body>
  <script>

    var lineData = [];
    var totalDays, numCases, numDeaths;
    var svg, lsvg;

    var nDeaths = 1;

    var margin = {top: 5, right: 5, bottom: 70, left: 70};

    // plot height and width
    // 400 should become div width
    var w = 500 - margin.left - margin.right;
    var h = 450 - margin.bottom - margin.top;

    // d3.csv("static/data.csv").then(function(data) {
    d3.csv("https://cors-anywhere.herokuapp.com/"
      + "https://opendata.ecdc.europa.eu/covid19/casedistribution/csv").then(function(data) {

      // add a d3 date to each column
      var startDate = new Date;
      var endDate = new Date;  // today
      numDeaths = 0;
      numCases = 0;

      // work out startDate
      for (var i=0; i<data.length; i++) {
        let row = data[i];
        let d = new Date(row.year, row.month-1, row.day)
        data[i].date = d;
        
        if (d3.timeDay.count(startDate, d) < 0) {
          startDate = d;
        }
      }

      // now parse to integer deaths and cases and work out num days
      for (var i=0; i<data.length; i++) {
        let row = data[i];
        let d = data[i].date;
        // need to convert to integer
        var rowDeaths = parseInt(row.deaths);
        var rowCases = parseInt(row.cases);
        data[i].deaths = rowDeaths;
        data[i].cases = rowCases;

        let numDays = d3.timeDay.count(startDate, d);
        data[i].numDays = numDays;
      }

      totalDays = d3.timeDay.count(startDate, endDate);
      var caseInterp = d3.interpolateLab("white", "red");
      // group data by country
      var byCountry = d3.nest()
        .key(function(d) { return d.countriesAndTerritories;})
          .sortValues(function(a,b) { return a.numDays - b.numDays; })
        .entries(data);

      /* go through each of the countries one at a time & calculate the
       * cumulative cases and deaths.
       */
      for (var i=0; i < byCountry.length; i++) {
        let country = byCountry[i];
        let values = country.values;

        // if a country didn't start recording on the start date, need to
        // offset their movement on the chart 
        country['startDelta'] = d3.timeDay.count(startDate, values[0].date);

        var nthDeathDate = startDate;

        values[0].newCases = values[0].cases;
        for (var j=1; j < values.length; j++) {
          values[j].newCases = values[j].cases;
          values[j].cases = values[j-1].cases + values[j].cases;
          values[j].deaths = values[j-1].deaths + values[j].deaths;

          // if still zero keep incrementing nthDeathDate
          if (values[j].deaths === 0) {
            nthDeathDate = values[j].date; 
          }

          if (values[j].deaths > numDeaths) {
            numDeaths = values[j].deaths;
          }

          if (values[j].cases > numCases) {
            numCases = values[j].cases;
          }
        }

        country['nthDeathDate'] = d3.timeDay.count(startDate, nthDeathDate);
      }

      // create SVG

      /* margin for the svg plot itself
         excluding the axis & labels
      */
      
      svg = d3.select("#graph")
        .append("svg")
          .attr("width", w+margin.left+margin.right)
          .attr("height", h+margin.top+margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

      var slider = d3Slider.sliderHorizontal()
        .domain([0, totalDays])
        .width(300)
        .tickFormat(d3.format('1'))
        .ticks(totalDays/5)
        .default(0)
        .on('onchange', val => {
          // TODO interpolate not hard change
          changeData(val)
        });

      // define data scales
      var x = d3.scaleLinear()
        .domain([0, numCases])
        .range([10, w-10]);

      var y = d3.scaleLinear()
        .domain([0, numDeaths])
        .range([h-10, 10]);  // bit of margin

      var colorRange = d3.scaleLinear()
        .domain([0, numCases])
        .range([0, 1]);

      var dateRange = d3.scaleLinear()
        .domain([0, totalDays])
        .range([0, 1]);

      // x axis group
      svg.append("g")
        .attr("class", "xaxis")
        .attr("transform", "translate(0,"+h+")")
        .call(d3.axisBottom(x)
                .tickFormat(d3.format(".2s")));

      // text label for the x axis
      svg.append("text")            
        .attr("transform",
              "translate(" + (w/2) + " ," + 
                           (h + margin.top + 50) + ")")
        .style("text-anchor", "middle")
        .attr("class", "axislabel")
        .text("cases");

      // y axis group
      svg.append("g")
        .attr("class", "yaxis")
        .call(d3.axisLeft(y)
                .tickFormat(d3.format(".2s")));

      // text label for the y axis
      svg.append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - (h / 2))
          .attr("dy", "1em")
          .attr("class", "axislabel")
          .style("text-anchor", "middle")
          .text("deaths");      

      // begin on day0
      var entered = svg.selectAll(".datapoint")
        .data(byCountry)
        .enter();
      
      entered.append("circle")
        .attr("class", "datapoint")
        .attr("cx", function (d) { return x(d.values[0].cases); })
        .attr("cy", function (d) { return y(d.values[0].deaths); })
        .attr("r", function(d) { return d.values[0].cases**0.3; })
        .attr("fill", function(d) {return caseInterp(colorRange(0))})
        .on("click", addLinePlot);

      entered.append("text")
        .attr("class", "label");
        // .attr("dx", function(d){return x(d.values[0].cases)-10;})
        // .attr("dy", function(d){return y(d.values[0].deaths)-5;});
       
      d3.select("#date")
        .append("text")
        .text(startDate.toDateString());

      function calculateVal(val, delta, values) {
        val = Math.round(val);

        // this means the country hasn't recorded yet
        if (delta > val) {
          return 0;
        }

        // maybe the country stopped recording?
        var val_;
        if (val > values.length - 1) {
          val_ = values.length - 1;
        } else { val_ = val;}
        return val_;
      }

      function changeData(val) {
        svg.selectAll(".datapoint")
          .transition()
          .duration(100)
            .ease(d3.easeLinear)
            .attr("cx", function (d) {
              let val_ = calculateVal(val, d.delta, d.values);
              return x(d.values[val_].cases); })
            .attr("cy", function (d) {
              let val_ = calculateVal(val, d.delta, d.values);
              return y(d.values[val_].deaths);
            })
            .attr("r", function(d) {
              let val_ = calculateVal(val, d.delta, d.values);
              return d.values[val_].cases**0.3;
            })
            .attr("fill", function(d) {
              let val_ = calculateVal(val, d.delta, d.values);
              var i = d.values[val_].cases;
              return caseInterp(colorRange(i))});   

        svg.selectAll(".label")
          .transition()
          .duration(100)
            .ease(d3.easeLinear)
            .attr("dx", function(d){
              let val_ = calculateVal(val, d.delta, d.values);
              return x(d.values[val_].cases)-10;})
            .attr("dy", function(d){
              let val_ = calculateVal(val, d.delta, d.values);
              return y(d.values[val_].deaths)+2.5;})
            .text(function(d){
              let val_ = calculateVal(val, d.delta, d.values);
              if ((d.values[val_].cases > 50000) | d.values[val_].deaths > 2000) {
                return d.values[val_].countryterritoryCode;
              } else {
                return ""
              }});

        d3.select("#date")
          .text(function() { return d3.interpolateDate(startDate, endDate)(dateRange(val)).toDateString()});
      }
      
      d3.select("#slider")
        .append("svg")
        .attr("width", 500)
        .attr("height", 60)
        .append('g')
        .attr("transform", "translate(10,10)")
        .call(slider);

      lsvg = d3.select("#linegraph").append("svg")
          .attr("width", w+margin.left+margin.right)
          .attr("height", h+margin.top+margin.bottom)
        .append("g")
          .attr("id", "graphg")
          .attr("transform",
                "translate("+margin.left+","+margin.top+")");

      var xScale = d3.scaleLinear()
        .domain([0, totalDays])  // input scale
        .range([0, w]); // maps to output scale (window)

      // log scale
      var yScale = d3.scaleLog()
        .domain([1, numDeaths])
        .range([h, 0]);

      // x axis group
      lsvg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0,"+h+")")
          .call(d3.axisBottom(xScale));

      // text label for the x axis
      lsvg.append("text")            
        .attr("transform",
              "translate(" + (w/2) + " ," + 
                           (h + margin.top + 50) + ")")
        .style("text-anchor", "middle")
        .attr("class", "axislabel")
        .text("days");

      // y axis group
      lsvg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(yScale).ticks(4)
                .tickFormat(d3.format(".2s")));

      // text label for the y axis
      lsvg.append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - (h / 2))
          .attr("dy", "1em")
          .attr("class", "axislabel")
          .style("text-anchor", "middle")
          .text("deaths");      

      // TODO - make this nice
      var color = d3.scaleLinear()
        .range(["red", "lightred"])
        .domain([0, 1.0])
        .interpolate(d3.interpolateHsl);

      function keyFunc(d, i) {
        return d.key;
      }

      function addLinePlot(data, i) {     

        // need to remove this too!
        d3.selectAll(".line").style("stroke", function(d) {return d['col']})
                           .style("stroke-width", "3px");
        d3.selectAll(".bar").remove();

        /* first check if the country is already present
        ( & remove if necessary) */
        var country = data.key;
        var len = lineData.length;
        lineData = lineData.filter(function(d) { return d.key !== country;});
        lsvg.selectAll(".line")
          .data(lineData, keyFunc)
          .exit()
          .remove();

        lsvg.selectAll(".legend-entry")
          .data(lineData, keyFunc)
          .exit()
          .remove();

        // if removed, return
        if (lineData.length < len) {return;}

        // update data
        var col = d3.interpolateOrRd(Math.random()*0.9 + 0.1);
        data['col'] = col;
        lineData.push(data);

        // path object
        lsvg.selectAll(".line")
          .data(lineData, keyFunc)
          .enter()
            .append("path")
              .attr("class", "line")
              .attr("stroke", function(d) {return col; })
              .attr("d", function(data) {
                var ld = data.values.filter(
                    function(d){return d.deaths > nDeaths});
                var delta = data.nthDeathDate;
                var numDeathsDay0 = ld[0].deaths;
                var line = d3.line()
                  .x(function(d) {
                    return xScale(d.numDays - delta);})
                  .y(function(d) {
                    // + 1 for log scale
                    return yScale(d.deaths - numDeathsDay0 + 1);})
                  .curve(d3.curveBasis);
                  return line(ld);
              })
              .attr("stroke-dasharray", function(d) {
                var totalLength = this.getTotalLength();
                return totalLength + " " + totalLength})
              .attr("stroke-dashoffset", function(d) {
                var totalLength = this.getTotalLength();
                return totalLength;
              })
              .on("mouseover", handleLineMouseOver)
              .on("mouseout", handleLineMouseOut)
              .on("click", addLinePlot)
              .transition()
                .duration(1000)
                .ease(d3.easeLinear)
                .attr("stroke-dashoffset", 0);

        lsvg.selectAll(".legend-entry")
          .data(lineData, keyFunc)
          .enter()
          .append("text")
            .attr("class", "legend-entry")
            .style("opacity", 0.0)
            .attr("x", function(d, i) {
              return xScale(
                d.values[d.values.length-1].numDays - d.nthDeathDate) + 5;})
            .attr("y", function(d, i){ return yScale(
                d.values[d.values.length-1].deaths)})
            .style("fill", "darkgray") // function(d){ return d.col;})
            .text(function(d){ return d.key.replace(/_/g, " ");})
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .transition()
              .delay(1000)
              .duration(100)
              .ease(d3.easeLinear)
              .style("opacity", 1.0);
      }
    
      function addLinePlotFromText(country) {
        var i;
        for (i=0; i<byCountry.length; i++) {
          if (country === byCountry[i].key) {break;}
        }
        data = byCountry[i];
        addLinePlot(data, i);
      }

      // append country list to drop down
      d3.select("#country-drop-down")
        .selectAll(".country-li")
        .data(byCountry)
        .enter()
        .append("li")
          .attr('class', 'country-li')
          .attr("role", "presentation")
        .append("a")
          .on("click", function(d) { addLinePlotFromText(d.key)})
          .text(function(d) {return d.key;});

    });

    function clearFn() {
      var lineStuff = d3.select("#linegraph")
        .select("svg")
        .select("g")
      lineStuff.selectAll(".line")
               .remove();
      lineStuff.selectAll(".legend-entry")
               .remove();
      lineData = [];
    }

    function handleLineClick(d, i) {
      d3.select(this).remove();
      d3.select(".legend-entry").each(function(d, ii) {
        if (ii === i) {
          d3.select(this).remove();
        }
      });
    }

    function handleLineMouseOver(d, i) {
      
      // first modify all lines
      d3.selectAll(".line").style("stroke", "lightgray")
                           .style("stroke-width", "2px");

      d3.select(this).style("stroke-width", "6px");
      d3.select(this).style("stroke", d['col']);

      d3.selectAll(".legend-entry").style("fill", function(d, ii) {
        if (ii === i) {
          return d['col'];
        } else {
          return "darkgray";
        }
      });

      // now add barchart
      addBarChart(d);

    }

    function handleLineMouseOut(barData) {
      d3.selectAll(".line").style("stroke", function(d) {return d['col']})
                           .style("stroke-width", "3px");
      d3.selectAll(".legend-entry").style("fill", "darkgray");
      d3.selectAll(".bar").remove();

    }

    function addBarChart(barData) {

      var xScale = d3.scaleLinear()
        .domain([0, totalDays])  // input scale
        .range([0, w]); // maps to output scale (window)

      var maxCases = 0;
      for (var i=0; i < barData.values.length; i++ ) {
        if (barData.values[i].newCases > maxCases) {
          maxCases = barData.values[i].newCases;
        }
      }

      // log scale
      var yScale = d3.scaleLinear()
        .domain([0, maxCases])
        .range([h, 8*h/10.]);

      var delta = barData.nthDeathDate;
      lsvg.selectAll(".bar")
          .data(barData.values.filter(function(d) {
            return d.numDays > delta;}
          ))
        .enter()
          .append("rect")
          .attr("class", 'bar')
          .style("fill", barData.col)
          .attr("x", function(d, i) { return xScale(i); })
          .attr("width", xScale(1))
          .attr("y", function(d) {
            return yScale(0); })
          .attr("height", function(d) {
            return h - yScale(0);
          })
          .transition()
            .duration(100)
              .ease(d3.easeLinear)
              .attr("y", function(d) {
                return yScale(d.newCases); })
              .attr("height", function(d) {
                return h - yScale(d.newCases);
              })
          .delay(function(d, i){return(i*10);});

    }

  </script>
</html>